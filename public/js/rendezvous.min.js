function init(e){console.log("Connecting to signaling server"),signalingSocket=io(SIGNALING_SERVER),signalingSocket.on("connect",function(){console.log("Connected to signaling server"),localMediaStream?signalingSocket.emit("join",{channel:e}):setup_local_media(function(){signalingSocket.emit("join",{channel:e})})}),signalingSocket.on("disconnect",function(){for(peer_id in peerMediaElements)document.getElementById("video-container").removeChild(peerMediaElements[peer_id].parentNode),resizeVideos();for(peer_id in peers)peers[peer_id].close();peers={},peerMediaElements={}}),signalingSocket.on("channelFull",function(){window.location="/"}),signalingSocket.on("addPeer",function(e){var t=e.peer_id;t in peers||(peerConnection=new RTCPeerConnection({iceServers:ICE_SERVERS},{optional:[{DtlsSrtpKeyAgreement:!0}]}),peers[t]=peerConnection,peerConnection.onicecandidate=function(e){e.candidate&&signalingSocket.emit("relayICECandidate",{peer_id:t,ice_candidate:{sdpMLineIndex:e.candidate.sdpMLineIndex,candidate:e.candidate.candidate}})},peerConnection.onaddstream=function(e){const n=document.createElement("div");n.className="video";const i=document.createElement("video");n.appendChild(i),i.setAttribute("playsinline",!0),i.mediaGroup="remotevideo",i.autoplay=!0,i.controls=!1,peerMediaElements[t]=i,document.getElementById("video-container").appendChild(n),attachMediaStream(i,e.stream),resizeVideos()},peerConnection.addStream(localMediaStream),e.should_create_offer&&peerConnection.createOffer(function(e){peerConnection.setLocalDescription(e,function(){signalingSocket.emit("relaySessionDescription",{peer_id:t,session_description:e})},function(e){console.log(e),alert("Offer setLocalDescription failed!")})},function(e){console.log("Error sending offer: ",e)}))}),signalingSocket.on("sessionDescription",function(e){var t=e.peer_id,n=peers[t],i=e.session_description,o=new RTCSessionDescription(i);n.setRemoteDescription(o,function(){"offer"==i.type&&n.createAnswer(function(e){n.setLocalDescription(e,function(){signalingSocket.emit("relaySessionDescription",{peer_id:t,session_description:e})},function(e){console.log(e),alert("Answer setLocalDescription failed!")})},function(e){console.log("Error creating answer: ",e)})},function(e){console.log("setRemoteDescription error: ",e)})}),signalingSocket.on("iceCandidate",function(e){var t=peers[e.peer_id],n=e.ice_candidate;t.addIceCandidate(new RTCIceCandidate(n))}),signalingSocket.on("removePeer",function(e){var t=e.peer_id;t in peerMediaElements&&(document.getElementById("video-container").removeChild(peerMediaElements[t].parentNode),resizeVideos()),t in peers&&peers[t].close(),delete peers[t],delete peerMediaElements[e.peer_id]})}function setup_local_media(e,t){null==localMediaStream?(attachMediaStream=function(e,t){e.srcObject=t},navigator.mediaDevices.getUserMedia({audio:USE_AUDIO,video:USE_VIDEO}).then(t=>{document.getElementById("allowaccess").style.display="none",localMediaStream=t;const n=document.createElement("div");n.className="video",n.setAttribute("id","myVideoWrap"),document.getElementById("mutebtn").addEventListener("click",e=>{localMediaStream.getAudioTracks()[0].enabled=!localMediaStream.getAudioTracks()[0].enabled,e.target.className="fas fa-microphone"+(localMediaStream.getAudioTracks()[0].enabled?"":"-slash")}),document.getElementById("videomutebtn").addEventListener("click",e=>{localMediaStream.getVideoTracks()[0].enabled=!localMediaStream.getVideoTracks()[0].enabled,e.target.className="fas fa-video"+(localMediaStream.getVideoTracks()[0].enabled?"":"-slash")}),navigator.mediaDevices.enumerateDevices().then(e=>{const t=e.filter(e=>"videoinput"===e.kind);t.length>1?document.getElementById("swapcamerabtn").addEventListener("click",e=>{swapCamera()}):document.getElementById("swapcamerabtn").style.display="none"}),navigator.getDisplayMedia||navigator.mediaDevices.getDisplayMedia?document.getElementById("screensharebtn").addEventListener("click",e=>{toggleScreenSharing()}):document.getElementById("screensharebtn").style.display="none",document.getElementById("buttons").style.opacity="1";const i=document.createElement("video");n.appendChild(i),i.setAttribute("id","myVideo"),i.setAttribute("playsinline",!0),i.className="mirror",i.autoplay=!0,i.muted=!0,i.volume=0,i.controls=!1,document.getElementById("video-container").appendChild(n),attachMediaStream(i,t),resizeVideos(),e&&e()}).catch(e=>{alert("This app will not work without camera/microphone access."),t&&t()})):e&&e()}function toggleScreenSharing(){const e=document.getElementById("screensharebtn"),t=document.getElementById("videomutebtn");let n;IS_SCREEN_STREAMING?(n=navigator.mediaDevices.getUserMedia({video:!0}),t.className="fas fa-video"):n=navigator.getDisplayMedia?navigator.getDisplayMedia({video:!0}):navigator.mediaDevices.getDisplayMedia?navigator.mediaDevices.getDisplayMedia({video:!0}):navigator.mediaDevices.getUserMedia({video:{mediaSource:"screen"}}),n.then(t=>{IS_SCREEN_STREAMING=!IS_SCREEN_STREAMING;var n=peerConnection.getSenders().find(e=>!!e.track&&"video"===e.track.kind);n.replaceTrack(t.getVideoTracks()[0]),t.getVideoTracks()[0].enabled=!0;const i=new MediaStream([t.getVideoTracks()[0],localMediaStream.getAudioTracks()[0]]);localMediaStream=i,attachMediaStream(document.getElementById("myVideo"),i),document.getElementById("myVideo").classList.toggle("mirror"),e.classList.toggle("active");var o=document.getElementById("videomutebtn").getAttribute("disabled");o=null!==o,document.getElementById("videomutebtn").disabled=!o,t.getVideoTracks()[0].onended=function(){IS_SCREEN_STREAMING&&toggleScreenSharing()}}).catch(e=>{alert("Unable to share screen."),console.error(e)})}function startVideo(e){init(e),$(".offline").hide(),$("header").hide(),$("#video-container").show(),$("#allowaccess").show()}const appURL=()=>{const e="http"+("localhost"==location.hostname?"":"s")+"://";return e+location.hostname+("localhost"==location.hostname?":3000":"")};var SIGNALING_SERVER=appURL(),USE_AUDIO=!0,USE_VIDEO=!0,CAMERA="user",IS_SCREEN_STREAMING=!1,peerConnection=null,ICE_SERVERS=[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun3.l.google.com:19302"},{urls:"stun:stun4.l.google.com:19302"},{urls:"stun:stun.stunprotocol.org:3478"},{urls:"stun:stun.sipnet.net:3478"},{urls:"stun:stun.ideasip.com:3478"},{urls:"stun:stun.iptel.org:3478"}],signalingSocket=null,localMediaStream=null,peers={},peerMediaElements={};const resizeVideos=()=>{const e=["","one","two","three","four","five","six"],t=document.querySelectorAll(".video");document.querySelectorAll(".video").forEach(n=>{n.className="video "+e[t.length]})},swapCamera=()=>{CAMERA="user"==CAMERA?"environment":"user",USE_VIDEO="user"==CAMERA||{facingMode:{exact:CAMERA}},navigator.mediaDevices.getUserMedia({video:USE_VIDEO}).then(e=>{if(peerConnection){var t=peerConnection.getSenders().find(e=>!!e.track&&"video"===e.track.kind);t.replaceTrack(e.getVideoTracks()[0])}e.getVideoTracks()[0].enabled=!0;const n=new MediaStream([e.getVideoTracks()[0],localMediaStream.getAudioTracks()[0]]);localMediaStream=n,attachMediaStream(document.getElementById("myVideo"),n),document.getElementById("myVideo").classList.toggle("mirror")}).catch(e=>{alert("Error is swaping camera"),console.log(e)})};$("#join").submit(function(e){e.preventDefault(),window.location="/"+$("#room").val()}),$("document").ready(function(){var e=window.location.pathname.slice(1);""!=e&&(console.log("try to access to "+e),startVideo(e))});