function init(e){function t(e){signaling_socket.emit("join",{channel:e})}signaling_socket=io(SIGNALING_SERVER),signaling_socket.on("connect",function(){local_media_stream?t(e):setup_local_media(function(){t(e)})}),signaling_socket.on("disconnect",function(){for(peer_id in peer_media_elements)document.getElementById("content").removeChild(peer_media_elements[peer_id].parentNode),resizeVideos();for(peer_id in peers)peers[peer_id].close();peers={},peer_media_elements={}}),signaling_socket.on("channelFull",function(){window.location="/"}),signaling_socket.on("addPeer",function(e){var t=e.peer_id;if(!(t in peers)){var n=new RTCPeerConnection({iceServers:ICE_SERVERS},{optional:[{DtlsSrtpKeyAgreement:!0}]});peers[t]=n,n.onicecandidate=function(e){e.candidate&&signaling_socket.emit("relayICECandidate",{peer_id:t,ice_candidate:{sdpMLineIndex:e.candidate.sdpMLineIndex,candidate:e.candidate.candidate}})},n.onaddstream=function(e){const n=document.createElement("div");n.className="video";const i=document.createElement("video");if(n.appendChild(i),i.setAttribute("playsinline",!0),i.mediaGroup="remotevideo",i.autoplay=!0,i.controls=!1,peer_media_elements[t]=i,document.getElementById("content").appendChild(n),i.requestFullscreen){const e=document.createElement("button");e.className="fullscreenbtn fa fa-expand",e.addEventListener("click",e=>{i.requestFullscreen()}),n.appendChild(e)}attachMediaStream(i,e.stream),resizeVideos(),checkParticipantsCount()},n.addStream(local_media_stream),e.should_create_offer&&n.createOffer(function(e){n.setLocalDescription(e,function(){signaling_socket.emit("relaySessionDescription",{peer_id:t,session_description:e})},function(){alert("Offer setLocalDescription failed!")})},function(e){console.log("Error sending offer: ",e)})}}),signaling_socket.on("sessionDescription",function(e){var t=e.peer_id,n=peers[t],i=e.session_description,a=new RTCSessionDescription(i);n.setRemoteDescription(a,function(){"offer"==i.type&&n.createAnswer(function(e){n.setLocalDescription(e,function(){signaling_socket.emit("relaySessionDescription",{peer_id:t,session_description:e})},function(){Alert("Answer setLocalDescription failed!")})},function(e){console.log("Error creating answer: ",e)})},function(e){console.log("setRemoteDescription error: ",e)})}),signaling_socket.on("iceCandidate",function(e){var t=peers[e.peer_id],n=e.ice_candidate;t.addIceCandidate(new RTCIceCandidate(n))}),signaling_socket.on("removePeer",function(e){var t=e.peer_id;t in peer_media_elements&&(document.getElementById("content").removeChild(peer_media_elements[t].parentNode),resizeVideos()),t in peers&&peers[t].close(),delete peers[t],delete peer_media_elements[e.peer_id]})}function setup_local_media(e,t){null==local_media_stream?(attachMediaStream=function(e,t){e.srcObject=t},navigator.mediaDevices.getUserMedia({audio:USE_AUDIO,video:USE_VIDEO}).then(t=>{local_media_stream=t;const n=document.createElement("div");n.className="video",n.setAttribute("id","selfVideoWrap");const i=document.createElement("div");i.setAttribute("class","btn-container");const a=document.createElement("button");a.setAttribute("id","mutebtn"),a.className="fa fa-microphone",a.addEventListener("click",e=>{local_media_stream.getAudioTracks()[0].enabled=!local_media_stream.getAudioTracks()[0].enabled,e.target.className="fa fa-microphone"+(local_media_stream.getAudioTracks()[0].enabled?"":"-slash")}),i.appendChild(a);const o=document.createElement("button");o.setAttribute("id","videomutebtn"),o.className="fa fa-video",o.addEventListener("click",e=>{local_media_stream.getVideoTracks()[0].enabled=!local_media_stream.getVideoTracks()[0].enabled,e.target.className="fa fa-video"+(local_media_stream.getVideoTracks()[0].enabled?"":"-slash")}),i.appendChild(o);const s=document.createElement("button");s.setAttribute("id","screensharebtn"),s.className="fa fa-desktop",navigator.getDisplayMedia||navigator.mediaDevices.getDisplayMedia||navigator.userAgent.indexOf("Firefox")>=0?s.addEventListener("click",e=>{let t;t=IS_SCREEN_STREAMING?navigator.mediaDevices.getUserMedia({video:!0}):navigator.getDisplayMedia?navigator.getDisplayMedia({video:!0}):navigator.mediaDevices.getDisplayMedia?navigator.mediaDevices.getDisplayMedia({video:!0}):navigator.mediaDevices.getUserMedia({video:{mediaSource:"screen"}}),t.then(e=>{IS_SCREEN_STREAMING&&local_media_stream.getVideoTracks()[0].stop(),local_media_stream.removeTrack(local_media_stream.getVideoTracks()[0]),local_media_stream.addTrack(e.getVideoTracks()[0]),IS_SCREEN_STREAMING=!IS_SCREEN_STREAMING,signaling_socket.disconnect(),init(),document.getElementById("selfVideo").classList.toggle("mirror")}).catch(e=>{alert("Unable to share screen."),console.error(e)})}):s.setAttribute("disabled",!0),i.appendChild(s),n.appendChild(i);const c=document.createElement("video");n.appendChild(c),c.setAttribute("id","selfVideo"),c.setAttribute("playsinline",!0),c.className="mirror",c.autoplay=!0,c.muted=!0,c.volume=0,c.controls=!1,document.getElementById("content").appendChild(n),attachMediaStream(c,t),resizeVideos(),e&&e()}).catch(()=>{alert("This site will not work without camera/microphone access."),t&&t()})):e&&e()}function startVideo(e){init(e),$(".offline").hide(),$("header").hide(),$("#video-container").show()}const appURL=()=>{const e="http"+("localhost"==location.hostname?"":"s")+"://";return e+location.hostname+("localhost"==location.hostname?":3000":"")};var SIGNALING_SERVER=appURL(),USE_AUDIO=!0,USE_VIDEO=!0,IS_SCREEN_STREAMING=!1,ICE_SERVERS=[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun.stunprotocol.org:3478"},{urls:"stun:stun.sipnet.net:3478"},{urls:"stun:stun.ideasip.com:3478"},{urls:"stun:stun.iptel.org:3478"}],signaling_socket=null,local_media_stream=null,peers={},peer_media_elements={};const resizeVideos=()=>{const e=["","one","two","three","four","five","six"],t=document.querySelectorAll(".video");document.querySelectorAll(".video").forEach(n=>{n.className="video "+e[t.length]})},checkParticipantsCount=()=>{const e=document.querySelectorAll(".video");e.length>4&&(document.getElementById("tooManyParticipants").style.display="block",setTimeout(()=>{document.getElementById("tooManyParticipants").style.display="none"},3e3)),e.length>1&&(document.getElementById("intro").style.display="none")};$("#join").submit(function(e){e.preventDefault(),window.location="/"+$("#room").val()}),$("document").ready(function(){var e=window.location.pathname.slice(1);""!=e&&(console.log("try to access to "+e),startVideo(e))});